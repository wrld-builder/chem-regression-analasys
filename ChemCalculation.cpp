/**
 * \file ChemCalculation.cpp
 * \brief Реализация класса ChemCalculation для расчёта параметров химической реакции.
 *
 * Данный файл содержит реализацию метода \c Calculate, который выполняет расчет параметров химической реакции,
 * используя экспериментальные данные (значения Ca и Tm) и начальные концентрации Cb и Cc.
 *
 * \author Шунин Михаил Дмитриевич
 * \date Февраль 2025
 */

#include "ChemCalculation.h"

#include <cmath>
#include <sstream>
#include <stdexcept>

#include "Utils.h"

/**
 * \brief Выполняет расчёт параметров химической реакции.
 *
 * Функция принимает экспериментальные данные, представленные в виде двух векторов:
 * - \a Ca содержит значения концентрации A,
 * - \a Tm содержит соответствующие значения времени.
 *
 * Дополнительно задаются начальные концентрации:
 * - \a Cb для вещества B,
 * - \a Cc для вещества C.
 *
 * Перед началом расчёта функция проверяет корректность входных данных:
 * - Начальные концентрации \a Cb и \a Cc не могут быть отрицательными.
 * - Все значения вектора \a Ca должны быть неотрицательными.
 * - Значения вектора \a Tm должны строго возрастать (t[i+1] > t[i]).
 * - Для расчёта требуется не менее двух точек.
 *
 * Затем выполняется регрессионный анализ методом наименьших квадратов:
 * - Вычисляются суммарные коэффициенты (s2, s3, s4, s5, s6) на основе логарифмов скорости реакции и концентрации.
 * - Из них рассчитывается порядок реакции \a n и константа скорости \a k.
 * - Коэффициент корреляции \a r также определяется на основе полученных сумм.
 *
 * Далее функция вычисляет дисперсию (\a disp) методом интегрирования с использованием подшагов:
 * - Интегрирование производится по интервалам между экспериментальными точками.
 * - Для каждого интервала вычисляется разница между экспериментальным значением и смоделированным,
 *   затем суммируются квадраты этих разниц.
 *
 * \param Ca Вектор экспериментальных значений концентрации A.
 * \param Tm Вектор экспериментальных значений времени.
 * \param Cb Начальная концентрация вещества B.
 * \param Cc Начальная концентрация вещества C.
 *
 * \return Структура \c CalculationResult, содержащая рассчитанные параметры:
 * - \a n: Порядок реакции.
 * - \a k: Константа скорости.
 * - \a r: Коэффициент корреляции.
 * - \a disp: Дисперсия.
 *
 * \throw std::runtime_error Если входные данные некорректны:
 * - Если \a Cb или \a Cc отрицательны.
 * - Если какое-либо значение в \a Ca отрицательно.
 * - Если значения в \a Tm не возрастают.
 * - Если количество точек меньше двух.
 * - Если возникает деление на ноль при вычислении коэффициентов регрессионного анализа.
 */
CalculationResult ChemCalculation::Calculate(const std::vector<double>& Ca,
                                             const std::vector<double>& Tm,
                                             double Cb, double Cc) {
  CalculationResult result = {0.0, 0.0, 0.0, 0.0};
  const int nPoints = static_cast<int>(Ca.size());

  // Проверка входных данных: начальные концентрации не должны быть отрицательными.
  if (Cb < 0.0 || Cc < 0.0) {
    throw std::runtime_error("Начальные концентрации Cb и Cc не могут быть отрицательными!");
  }
  // Проверка значений концентрации A
  for (size_t i = 0; i < Ca.size(); i++) {
    if (Ca[i] < 0.0)
      throw std::runtime_error("Значение Ca не может быть отрицательным!");
  }
  // Проверка, что значения времени строго возрастают
  for (int i = 0; i < nPoints - 1; i++) {
    if (Tm[i + 1] <= Tm[i])
      throw std::runtime_error("Время должно строго возрастать (t[i+1] > t[i])!");
  }
  // Должно быть не менее двух точек для проведения расчёта
  if (nPoints < 2)
    throw std::runtime_error("Недостаточно точек для расчёта!");

  // Вычисление коэффициентов для регрессионного анализа.
  // s1 - количество интервалов между точками.
  double s1 = static_cast<double>(nPoints - 1);
  double s2 = 0.0, s3 = 0.0, s4 = 0.0, s5 = 0.0, s6 = 0.0;
  for (int i = 0; i < nPoints - 1; i++) {
    double dC = Ca[i + 1] - Ca[i];
    double dt = Tm[i + 1] - Tm[i];
    // Предотвращаем деление на очень малое число
    if (dt <= 1e-15)
      dt = 1e-15;
    // Вычисляем абсолютное значение скорости изменения концентрации
    double w = fabs(dC / dt);
    // Используем защиту от слишком малых значений концентрации
    double cVal = (Ca[i] < 1e-15) ? 1e-15 : Ca[i];
    double y = log(w);
    double x = log(cVal);
    s2 += x;
    s3 += y;
    s4 += x * x;
    s5 += x * y;
    s6 += y * y;
  }
  // Вычисление знаменателя для регрессионного уравнения
  double denom = (s1 * s4 - s2 * s2);
  if (fabs(denom) < 1e-15)
    throw std::runtime_error("Невозможно вычислить (деление на ноль). Проверьте данные!");

  // Расчёт порядка реакции n и временной компоненты для определения константы скорости k.
  result.n = (s1 * s5 - s2 * s3) / denom;
  double t_k = (s3 * s4 - s2 * s5) / denom;
  result.k = exp(t_k);

  // Расчёт коэффициента корреляции
  double denom_r = sqrt((s1 * s4 - s2 * s2) * (s1 * s6 - s3 * s3));
  if (denom_r < 1e-15)
    denom_r = 1e-15;
  result.r = (s1 * s5 - s2 * s3) / denom_r;

  // Вычисление дисперсии методом интегрирования с использованием подшагов.
  double sumSq = 0.0;
  double Acur = Ca[0];
  double tcur = Tm[0];
  for (int i = 1; i < nPoints; i++) {
    double dtFull = Tm[i] - tcur;
    const int subSteps = 20;  // Количество подшагов интегрирования
    double dtSub = dtFull / subSteps;
    double Atemp = Acur;
    // Интегрирование для моделирования изменения концентрации A
    for (int s = 0; s < subSteps; s++) {
      double rate = result.k * pow(Atemp, result.n);
      Atemp -= rate * dtSub;
    }
    // Разница между экспериментальным и смоделированным значением концентрации A
    double diff = Ca[i] - Atemp;
    sumSq += diff * diff;
    Acur = Atemp;
    tcur = Tm[i];
  }
  result.disp = sumSq / (nPoints - 1);

  return result;
}
